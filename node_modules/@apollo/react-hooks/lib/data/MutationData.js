import * as tslib_1 from "tslib";
import { ApolloError } from 'apollo-client';
import { isEqual } from 'apollo-utilities';
import { DocumentType } from '@apollo/react-common';
import { OperationData } from './OperationData';
var MutationData = (function (_super) {
    tslib_1.__extends(MutationData, _super);
    function MutationData(_a) {
        var options = _a.options, context = _a.context, result = _a.result, setResult = _a.setResult;
        var _this = _super.call(this, options, context) || this;
        _this.verifyDocumentType(options.mutation, DocumentType.Mutation);
        _this.result = result;
        _this.setResult = setResult;
        _this.mostRecentMutationId = 0;
        return _this;
    }
    MutationData.prototype.execute = function (result) {
        var _this = this;
        this.verifyDocumentType(this.options.mutation, DocumentType.Mutation);
        var runMutation = function (options) { return _this.runMutation(options); };
        return [runMutation, result];
    };
    MutationData.prototype.afterExecute = function () {
        this.isMounted = true;
        return this.unmount.bind(this);
    };
    MutationData.prototype.cleanup = function () {
    };
    MutationData.prototype.runMutation = function (mutationFunctionOptions) {
        var _this = this;
        if (mutationFunctionOptions === void 0) { mutationFunctionOptions = {}; }
        this.onMutationStart();
        var mutationId = this.generateNewMutationId();
        return this.mutate(mutationFunctionOptions)
            .then(function (response) {
            _this.onMutationCompleted(response, mutationId);
            return response;
        })
            .catch(function (error) {
            _this.onMutationError(error, mutationId);
            if (!_this.options.onError)
                throw error;
        });
    };
    MutationData.prototype.mutate = function (mutationFunctionOptions) {
        var _a = this.options, mutation = _a.mutation, variables = _a.variables, optimisticResponse = _a.optimisticResponse, update = _a.update, _b = _a.context, mutationContext = _b === void 0 ? {} : _b, _c = _a.awaitRefetchQueries, awaitRefetchQueries = _c === void 0 ? false : _c, fetchPolicy = _a.fetchPolicy;
        var mutateOptions = tslib_1.__assign({}, mutationFunctionOptions);
        var refetchQueries = mutateOptions.refetchQueries || this.options.refetchQueries;
        var mutateVariables = Object.assign({}, variables, mutateOptions.variables);
        delete mutateOptions.variables;
        return this.refreshClient().client.mutate(tslib_1.__assign({ mutation: mutation,
            optimisticResponse: optimisticResponse,
            refetchQueries: refetchQueries,
            awaitRefetchQueries: awaitRefetchQueries,
            update: update, context: mutationContext, fetchPolicy: fetchPolicy, variables: mutateVariables }, mutateOptions));
    };
    MutationData.prototype.onMutationStart = function () {
        if (!this.result.loading && !this.options.ignoreResults) {
            this.updateResult({
                loading: true,
                error: undefined,
                data: undefined,
                called: true
            });
        }
    };
    MutationData.prototype.onMutationCompleted = function (response, mutationId) {
        var _a = this.options, onCompleted = _a.onCompleted, ignoreResults = _a.ignoreResults;
        var data = response.data, errors = response.errors;
        var error = errors && errors.length > 0
            ? new ApolloError({ graphQLErrors: errors })
            : undefined;
        var callOncomplete = function () {
            return onCompleted ? onCompleted(data) : null;
        };
        if (this.isMostRecentMutation(mutationId) && !ignoreResults) {
            this.updateResult({
                called: true,
                loading: false,
                data: data,
                error: error
            });
        }
        callOncomplete();
    };
    MutationData.prototype.onMutationError = function (error, mutationId) {
        var onError = this.options.onError;
        var callOnError = function () { return (onError ? onError(error) : null); };
        if (this.isMostRecentMutation(mutationId)) {
            this.updateResult({
                loading: false,
                error: error,
                data: undefined,
                called: true
            });
        }
        callOnError();
    };
    MutationData.prototype.generateNewMutationId = function () {
        this.mostRecentMutationId += 1;
        return this.mostRecentMutationId;
    };
    MutationData.prototype.isMostRecentMutation = function (mutationId) {
        return this.mostRecentMutationId === mutationId;
    };
    MutationData.prototype.updateResult = function (result) {
        if (this.isMounted &&
            (!this.previousResult || !isEqual(this.previousResult, result))) {
            this.setResult(result);
            this.previousResult = result;
        }
    };
    return MutationData;
}(OperationData));
export { MutationData };
//# sourceMappingURL=MutationData.js.map